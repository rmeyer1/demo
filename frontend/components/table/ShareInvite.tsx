\"use client\";\n\nimport { useState } from \"react\";\nimport { Button } from \"@/components/ui/Button\";\nimport { Input } from \"@/components/ui/Input\";\nimport { Modal } from \"@/components/ui/Modal\";\nimport { useToast } from \"@/components/ui/use-toast\"; // Assuming a toast component/hook\nimport { apiClient, ApiError } from \"@/lib/apiClient\";\n\ninterface ShareInviteProps {\n  tableId: string;\n  inviteCode: string;\n  tableName: string;\n}\n\nexport function ShareInvite({ tableId, inviteCode, tableName }: ShareInviteProps) {\n  const { toast } = useToast();\n  const [showEmailModal, setShowEmailModal] = useState(false);\n  const [emailsInput, setEmailsInput] = useState(\"\");\n  const [emailErrors, setEmailErrors] = useState<Record<string, string>>({});\n  const [isSending, setIsSending] = useState(false);\n  const [sendResults, setSendResults] = useState<Array<{ email: string; success: boolean; error?: string }>>([]);\n\n  const handleCopyInviteCode = async () => {\n    try {\n      await navigator.clipboard.writeText(inviteCode);\n      toast({\n        title: \"Copied!\",\n        description: \"Invite code copied to clipboard.\",\n      });\n    } catch (err) {\n      console.error(\"Failed to copy invite code: \", err);\n      toast({\n        title: \"Copy Failed\",\n        description: \"Could not copy invite code.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const validateEmails = (emailString: string) => {\n    const emailArray = emailString.split(\",\").map((e) => e.trim()).filter(Boolean);\n    const errors: Record<string, string> = {};\n    const emailRegex = /^[^\s@]+@[^\s@]+\\.[^\s@]+$/;\n\n    emailArray.forEach((email) => {\n      if (!emailRegex.test(email)) {\n        errors[email] = \"Invalid email format\";\n      }\n    });\n    setEmailErrors(errors);\n    return Object.keys(errors).length === 0 ? emailArray : null;\n  };\n\n  const handleSendEmails = async () => {\n    const validEmails = validateEmails(emailsInput);\n    if (!validEmails || validEmails.length === 0) {\n      toast({\n        title: \"Validation Error\",\n        description: \"Please enter valid email addresses.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsSending(true);\n    setSendResults([]);\n    try {\n      const response = await apiClient.post(`/api/tables/${tableId}/send-invite`, {\n        emails: validEmails,\n      });\n      setSendResults(response.results || []);\n      toast({\n        title: \"Invitations Sent\",\n        description: \"Email invitations have been processed.\",\n      });\n      setEmailsInput(\"\"); // Clear input on success\n      // setShowEmailModal(false); // Optionally close modal on success\n    } catch (error) {\n      console.error(\"Failed to send invite emails:\", error);\n      const message = error instanceof ApiError ? error.message : \"Failed to send invite emails.\";\n      toast({\n        title: \"Error Sending Invites\",\n        description: message,\n        variant: \"destructive\",\n      });\n      setSendResults(\n        validEmails.map((email) => ({\n          email,\n          success: false,\n          error: \"Failed to send due to server error.\",\n        }))\n      );\n    } finally {\n      setIsSending(false);\n    }\n  };\n\n  return (\n    <div className=\"bg-slate-700 p-4 rounded-lg shadow-md\">\n      <h3 className=\"text-lg font-semibold text-white mb-3\">Invite Players</h3>\n      <div className=\"flex items-center space-x-2 mb-4\">\n        <Input\n          readOnly\n          value={inviteCode}\n          className=\"flex-grow bg-slate-800 border-slate-600 text-amber-300 font-mono\"\n          aria-label=\"Invite Code\"\n        />\n        <Button onClick={handleCopyInviteCode} variant=\"secondary\">\n          Copy\n        </Button>\n      </div>\n      <p className=\"text-sm text-slate-300 mb-4\">\n        Share this code with friends to invite them to \"{tableName}\".\n      </p>\n\n      <Button onClick={() => setShowEmailModal(true)} className=\"w-full\">\n        Share via Email\n      </Button>\n\n      <Modal\n        isOpen={!!showEmailModal}\n        onClose={() => {\n          if (!isSending) {\n            setShowEmailModal(false);\n            setEmailsInput(\"\");\n            setEmailErrors({});\n            setSendResults([]);\n          }\n        }}\n        title={`Invite to \"${tableName}\"`}\n      >\n        <div className=\"space-y-4\">\n          <p className=\"text-sm text-slate-300\">\n            Enter email addresses (comma-separated) to send invitations.\n          </p>\n          <Input\n            label=\"Recipient Emails\"\n            type=\"text\"\n            value={emailsInput}\n            onChange={(e) => setEmailsInput(e.target.value)}\n            placeholder=\"e.g., friend1@example.com, friend2@example.com\"\n            disabled={isSending}\n          />\n          {Object.keys(emailErrors).length > 0 && (\n            <div className=\"rounded-md border border-red-700 bg-red-900/40 px-3 py-2 text-sm text-red-200\">\n              {Object.entries(emailErrors).map(([email, error]) => (\n                <p key={email}>\n                  {email}: {error}\n                </p>\n              ))}\n            </div>\n          )}\n\n          {sendResults.length > 0 && (\n            <div className=\"space-y-2 max-h-48 overflow-y-auto pr-2\">\n              <p className=\"text-sm font-medium text-slate-200\">Send Results:</p>\n              {sendResults.map((result, index) => (\n                <div key={index} className={`flex items-center justify-between text-sm ${\n                  result.success ? \"text-emerald-300\" : \"text-red-300\"\n                }`}>\n                  <span>{result.email}</span>\n                  <span>{result.success ? \"Sent\" : `Failed: ${result.error}`}</span>\n                </div>\n              ))}\n            </div>\n          )}\n\n          <div className=\"flex justify-end gap-3\">\n            <Button\n              variant=\"ghost\"\n              onClick={() => {\n                if (!isSending) {\n                  setShowEmailModal(false);\n                  setEmailsInput(\"\");\n                  setEmailErrors({});\n                  setSendResults([]);\n                }\n              }}\n              disabled={isSending}\n            >\n              Cancel\n            </Button>\n            <Button onClick={handleSendEmails} disabled={isSending}>\n              {isSending ? \"Sending...\" : \"Send Invites\"}\n            </Button>\n          </div>\n        </div>\n      </Modal>\n    </div>\n  );\n}\n