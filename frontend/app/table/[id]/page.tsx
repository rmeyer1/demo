\"use client\";\n\nimport { useCallback, useEffect, useMemo, useState } from \"react\";\nimport { useParams, useRouter, useSearchParams } from \"next/navigation\";\nimport { useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useTableState } from \"@/hooks/useTableState\";\nimport { useChat } from \"@/hooks/useChat\";\nimport { useWebSocket } from \"@/hooks/useWebSocket\";\nimport { apiClient, ApiError } from \"@/lib/apiClient\";\nimport type { Table } from \"@/lib/types\";\nimport { PokerTable } from \"@/components/table/PokerTable\";\nimport { ActionControls } from \"@/components/table/ActionControls\";\nimport { TableHud } from \"@/components/table/TableHud\";\nimport { ChatPanel } from \"@/components/chat/ChatPanel\";\nimport { HandResultOverlay } from \"@/components/table/HandResultOverlay\";\nimport { Modal }mport { Input } from \"@/components/ui/Input\";\nimport { Button } from \"@/components/ui/Button\";\nimport { ShareInvite } from \"@/components/table/ShareInvite\"; // Import ShareInvite component\n\nexport default function TablePage() {\n  const params = useParams();\n  const router = useRouter();\n  const queryClient = useQueryClient();\n  const searchParams = useSearchParams();\n  const tableId = params.id as string;\n  const inviteCode = searchParams.get(\"inviteCode\");\n  const { user, loading: authLoading } = useAuth();\n  const storedInvite = typeof window !== \"undefined\" && tableId\n    ? localStorage.getItem(`tableInvite:${tableId}`)\n    : null;\n  const effectiveInvite = inviteCode || storedInvite || null;\n\n  const { tableState, handResult, clearHandResult, connected } = useTableState(tableId, effectiveInvite);\n  const { messages, sendMessage, connected: chatConnected } = useChat(tableId, effectiveInvite);\n  const { emit, on } = useWebSocket(tableId, effectiveInvite);\n  const [actionError, setActionError] = useState<string | null>(null);\n  const [seatPrompt, setSeatPrompt] = useState<{ seatIndex: number } | null>(null);\n  const [buyInAmount, setBuyInAmount] = useState(\"\");\n  const [seatError, setSeatError] = useState<string | null>(null);\n  const [seatSubmitting, setSeatSubmitting] = useState(false);\n  const [startPending, setStartPending] = useState(false);\n  const [startError, setStartError] = useState<string | null>(null);\n  const [standPending, setStandPending] = useState(false);\n  const [standError, setStandError] = useState<string | null>(null);\n\n  // Persist invite code so reloads/reconnects keep access\n  useEffect(() => {\n    if (inviteCode && tableId) {\n      localStorage.setItem(`tableInvite:${tableId}`, inviteCode);\n    }\n  }, [inviteCode, tableId]);\n\n  useEffect(() => {\n    if (!on) return;\n\n    const unsubscribe = on(\"ERROR\", (...args: unknown[]) => {\n      const payload = (args[0] || {}) as { code?: string; message?: string };\n      const code = payload.code || \"\";\n      const message = payload.message || \"Action failed.\";\n\n      if (startPending && (code === \"NOT_TABLE_HOST\" || code === \"START_CONDITIONS_UNMET\" || code === \"HAND_ALREADY_ACTIVE\" || code.startsWith(\"GAME_START\"))) {\n        setStartError(message);\n        setStartPending(false);\n      }\n\n      if (standPending && (code === \"NOT_SEATED\" || code === \"HAND_IN_PROGRESS\")) {\n        setStandError(message);\n        setStandPending(false);\n      }\n    });\n\n    return () => {\n      unsubscribe?.();\n    };\n  }, [on, startPending, standPending]);\n\n  const { data: table, isLoading } = useQuery({\n    queryKey: [\"table\", tableId, effectiveInvite],\n    queryFn: () =>\n      apiClient.get<Table>(\n        `/api/tables/${tableId}${effectiveInvite ? `?inviteCode=${encodeURIComponent(effectiveInvite)}` : \"\"}`\n      ),\n    enabled: !!tableId && !!user,\n  });\n\n  useEffect(() => {\n    if (!authLoading && !user) {\n      router.push(\"/auth/login\");\n    }\n  }, [authLoading, user, router]);\n\n  const handleAction = (\n    action: \"FOLD\" | \"CHECK\" | \"CALL\" | \"BET\" | \"RAISE\",\n    amount?: number\n  ) => {\n    setActionError(null);\n    if (!tableState) return;\n\n    // Basic client-side validation to reduce server rejections\n    if (!tableState.handId) {\n      setActionError(\"Hand not active yet.\");\n      return;\n    }\n\n    const selfSeat = tableState.seats.find((s) => s.isSelf);\n    if (!selfSeat || tableState.toActSeatIndex !== selfSeat.seatIndex) {\n      setActionError(\"Not your turn.\");\n      return;\n    }\n\n    if (action === \"CHECK\" && (tableState.callAmount || 0) > 0) {\n      setActionError(\"Cannot check when facing a bet.\");\n      return;\n    }\n\n    if (action === \"CALL\" && (tableState.callAmount || 0) === 0) {\n      // If the call amount dropped to zero between renders, fall back to CHECK to avoid backend rejection.\n      emit(\"PLAYER_ACTION\", {\n        tableId,\n        handId: tableState.handId,\n        action: \"CHECK\",\n      });\n      return;\n    }\n\n    if ((action === \"BET\" || action === \"RAISE\") && (!amount || amount < (tableState.minBet || 0))) {\n      setActionError(`Bet/Raise must be at least ${tableState.minBet || 0}.`);\n      return;\n    }\n\n    emit(\"PLAYER_ACTION\", {\n      tableId,\n      handId: tableState.handId,\n      action,\n      amount,\n    });\n  };\n\n  const isSeated = useMemo(\n    () => tableState?.seats.some((s) => s.isSelf) ?? false,\n    [tableState]\n  );\n\n  const mySeat = useMemo(() => tableState?.seats.find((s) => s.isSelf), [tableState]);\n\n  const activePlayers = useMemo(\n    () =>\n      tableState\n        ? tableState.seats.filter(\n            (seat) => seat.stack > 0 && seat.status !== \"SITTING_OUT\"\n          )\n        : [],\n    [tableState]\n  );\n\n  const isHost = useMemo(\n    () => Boolean(table && user && user.id === table.hostUserId),\n    [table, user]\n  );\n\n  const canHostStart = useMemo(() => {\n    if (!tableState || !isHost || !mySeat) return false;\n    const hostReady = mySeat.stack > 0 && mySeat.status !== \"SITTING_OUT\";\n    const hasPartner = activePlayers.some((p) => p.seatIndex !== mySeat.seatIndex);\n    return hostReady && hasPartner && !tableState.handId;\n  }, [tableState, isHost, mySeat, activePlayers]);\n\n  useEffect(() => {\n    if (startPending && tableState) {\n      setStartPending(false);\n    }\n  }, [tableState, startPending]);\n\n  useEffect(() => {\n    if ((tableState?.handId && startError) || (!canHostStart && startError)) {\n      setStartError(null);\n    }\n  }, [tableState?.handId, canHostStart, startError]);\n\n  useEffect(() => {\n    if (standPending && (!tableState?.handId || !mySeat)) {\n      setStandPending(false);\n    }\n  }, [standPending, tableState?.handId, mySeat]);\n\n  const handleStartGame = useCallback(() => {\n    if (!canHostStart || startPending) return;\n    setStartError(null);\n    setStartPending(true);\n    emit(\"GAME_START\", { tableId });\n  }, [canHostStart, startPending, emit, tableId]);\n\n  const startControl = useMemo(\n    () =>\n      mySeat && canHostStart\n        ? {\n            seatIndex: mySeat.seatIndex,\n            pending: startPending,\n            error: startError,\n            onStart: handleStartGame,\n          }\n        : null,\n    [mySeat, canHostStart, startPending, startError, handleStartGame]\n  );\n\n  const canStand = useMemo(\n    () => Boolean(mySeat && !tableState?.handId),\n    [mySeat, tableState?.handId]\n  );\n\n  const handleStandUp = useCallback(() => {\n    if (!mySeat || standPending) return;\n    setStandError(null);\n    setStandPending(true);\n    emit(\"STAND_UP\", { tableId });\n  }, [emit, tableId, mySeat, standPending]);\n\n  const standControl = useMemo(\n    () =>\n      mySeat\n        ? {\n            seatIndex: mySeat.seatIndex,\n            disabled: !canStand,\n            disabledReason: tableState?.handId ? \"Available after this hand.\" : null,\n            pending: standPending,\n            error: standError,\n            onStand: handleStandUp,\n          }\n        : null,\n    [mySeat, canStand, tableState?.handId, standPending, standError, handleStandUp]\n  );\n\n  const handleSeatSelect = (seatIndex: number) => {\n    if (isSeated || !table) return;\n    if (!buyInAmount) {\n      const defaultBuyIn = Math.max(table.bigBlind * 20, table.bigBlind * 2);\n      setBuyInAmount(String(defaultBuyIn));\n    }\n    setSeatPrompt({ seatIndex });\n    setSeatError(null);\n  };\n\n  const closeSeatPrompt = () => {\n    if (seatSubmitting) return;\n    setSeatPrompt(null);\n    setSeatError(null);\n  };\n\n  const confirmSeatSelection = async () => {\n    if (!seatPrompt) return;\n    const amount = Number(buyInAmount);\n    if (!amount || Number.isNaN(amount) || amount <= 0) {\n      setSeatError(\"Enter a buy-in greater than zero.\");\n      return;\n    }\n\n    setSeatSubmitting(true);\n    setSeatError(null);\n    try {\n      await apiClient.post(`/api/tables/${tableId}/sit-down`, {\n        seatIndex: seatPrompt.seatIndex,\n        buyInAmount: amount,\n      });\n      await queryClient.invalidateQueries({ queryKey: [\"table\", tableId, effectiveInvite] });\n      setSeatPrompt(null);\n      setBuyInAmount(\"\");\n    } catch (error) {\n      const message = error instanceof ApiError ? error.message : \"Failed to take seat.\";\n      setSeatError(message);\n    } finally {\n      setSeatSubmitting(false);\n    }\n  };\n\n  if (authLoading || isLoading) {\n    return (\n      <div className=\"text-center text-slate-400 py-12\">Loading table...</div>\n    );\n  }\n\n  if (!table || !user) {\n    return null;\n  }\n\n  if (!tableState) {\n    return (\n      <div className=\"text-center text-slate-400 py-12\">\n        Waiting for table state...\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"max-w-7xl mx-auto\">\n      <TableHud tableName={table.name} tableMeta={table} tableState={tableState} />\n\n      {/* Share Invite Component - visible only to host */}\n      {isHost && table.inviteCode && (\n        <div className=\"mt-6\">\n          <ShareInvite\n            tableId={table.id}\n            inviteCode={table.inviteCode}\n            tableName={table.name}\n          />\n        </div>\n      )}\n\n      <div className=\"grid lg:grid-cols-4 gap-6\">\n        <div className=\"lg:col-span-3\">\n          <PokerTable\n            tableState={tableState}\n            tableMeta={table}\n            canSelectSeat={!isSeated}\n            onSeatSelect={handleSeatSelect}\n            startControl={startControl || undefined}\n            standControl={standControl || undefined}\n          />\n          <div className=\"mt-6\">\n            <ActionControls\n              tableState={tableState}\n              onAction={handleAction}\n            />\n            {actionError && (\n              <p className=\"text-red-400 text-sm mt-2 text-center\">{actionError}</p>\n            )}\n          </div>\n        </div>\n        <div className=\"lg:col-span-1\">\n          <ChatPanel\n            messages={messages}\n            onSendMessage={sendMessage}\n            connected={chatConnected}\n          />\n        </div>\n      </div>\n\n      {handResult && (\n        <HandResultOverlay\n          result={handResult}\n          seats={tableState.seats}\n          onClose={clearHandResult}\n        />\n      )}\n\n      {!connected && (\n        <div className=\"mt-4 text-center text-amber-300 text-sm\">\n          Reconnecting to table...\n        </div>\n      )}\n\n      {mySeat && tableState.toActSeatIndex === mySeat.seatIndex && (\n        <div className=\"mt-4 text-center text-emerald-300 text-sm\">\n          Your turn to act.\n        </div>\n      )}\n\n      <Modal\n        isOpen={!!seatPrompt}\n        onClose={closeSeatPrompt}\n        title={\n          seatPrompt !== null\n            ? `Take Seat ${seatPrompt.seatIndex + 1}?`\n            : \"Take a Seat\"\n        }\n      >\n        <div className=\"space-y-4\">\n          <p className=\"text-sm text-slate-300\">\n            Select your buy-in to take this seat and join the table.\n          </p>\n          <Input\n            label=\"Buy-in Amount\"\n            type=\"number\"\n            min={1}\n            value={buyInAmount}\n            onChange={(e) => setBuyInAmount(e.target.value)}\n            placeholder=\"Enter chips\"\n          />\n          {seatError && (\n            <div className=\"rounded-md border border-red-700 bg-red-900/40 px-3 py-2 text-sm text-red-200\">\n              {seatError}\n            </div>\n          )}\n          <div className=\"flex justify-end gap-3\">\n            <Button variant=\"ghost\" onClick={closeSeatPrompt} disabled={seatSubmitting}>\n              Cancel\n            </Button>\n            <Button onClick={confirmSeatSelection} disabled={seatSubmitting}>\n              {seatSubmitting ? \"Taking seat...\" : \"Confirm\"}\n            </Button>\n          </div>\n        </div>\n      </Modal>\n    </div>\n  );\n}